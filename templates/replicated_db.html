<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Replicated Database Visualizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
        }
        .container {
            margin-top: 20px;
        }
        #db-log {
            background-color: #333;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
            padding: 15px;
            height: 30vh;
            overflow-y: scroll;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .chunk-card {
            margin-bottom: 20px;
        }
        .chunk-card .card-header {
            cursor: pointer;
        }
        .lock-status {
            font-weight: bold;
        }
        .lock-status.unlocked { color: #28a745; }
        .lock-status.read-locked { color: #ffc107; }
        .lock-status.write-locked { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Replicated Database Visualizer ðŸ“Š</h1>
        
        <!-- Action Section -->
        <div class="card mb-4">
            <div class="card-header">
                Database Operations
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Read & Lock</h4>
                        <form id="read-form">
                            <div class="input-group mb-3">
                                <input type="number" class="form-control" id="read-roll" placeholder="Roll No" min="1" max="28">
                                <button class="btn btn-primary" type="submit">Read</button>
                                <button class="btn btn-danger" type="button" id="lock-btn">Lock</button>
                                <button class="btn btn-success" type="button" id="unlock-btn">Unlock</button>
                            </div>
                        </form>
                        <div id="read-output" class="mt-3"></div>
                    </div>
                    <div class="col-md-6">
                        <h4>Write Operation</h4>
                        <form id="write-form">
                            <div class="input-group mb-3">
                                <input type="number" class="form-control" id="write-roll" placeholder="Roll No" min="1" max="28" required>
                            </div>
                            <div class="row mb-3">
                                <div class="col"><input type="number" class="form-control" id="write-ias" placeholder="IAS"></div>
                                <div class="col"><input type="number" class="form-control" id="write-mse" placeholder="MSE"></div>
                                <div class="col"><input type="number" class="form-control" id="write-ese" placeholder="ESE"></div>
                            </div>
                            <button class="btn btn-warning w-100" type="submit">Write to DB</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Log Section -->
        <div class="card mb-4">
            <div class="card-header">
                Live Database Log
            </div>
            <div id="db-log" class="card-body">
            </div>
        </div>

        <!-- Database Chunks & Lock Status -->
        <h2 class="mb-3">Live Database Chunks</h2>
        <div id="chunks-container">
            <!-- Chunks will be dynamically loaded here -->
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const socket = io();
        const dbLogDiv = document.getElementById('db-log');
        const chunksContainer = document.getElementById('chunks-container');

        function appendLog(message, type = 'info') {
            const p = document.createElement('p');
            p.innerHTML = `>> <span class="text-${type}">${message}</span>`;
            dbLogDiv.appendChild(p);
            dbLogDiv.scrollTop = dbLogDiv.scrollHeight;
        }

        function renderChunks(dbData) {
            chunksContainer.innerHTML = '';
            // Group students by chunk
            const chunks = dbData.metadata.chunks.reduce((acc, chunk) => {
                acc[chunk.id] = { ...chunk, students: [] };
                return acc;
            }, {});

            Object.values(dbData.primary).forEach(student => {
                const chunkId = dbData._chunk_for_roll(student.roll);
                if (chunks[chunkId]) {
                    chunks[chunkId].students.push(student);
                }
            });

            Object.values(chunks).forEach(chunk => {
                const chunkElement = document.createElement('div');
                chunkElement.className = 'card chunk-card';
                chunkElement.innerHTML = `
                    <div class="card-header" id="chunk-header-${chunk.id}" data-bs-toggle="collapse" data-bs-target="#chunk-${chunk.id}" aria-expanded="false">
                        <h5 class="mb-0">
                            Chunk ${chunk.id} (Rolls ${chunk.range[0]} - ${chunk.range[1]})
                            <span class="lock-status float-end" id="lock-status-${chunk.id}">
                                Unlocked
                            </span>
                        </h5>
                    </div>
                    <div id="chunk-${chunk.id}" class="collapse">
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                ${chunk.students.map(s => `
                                    <li class="list-group-item">
                                        <strong>Roll ${s.roll}</strong>: ${s.name} <br>
                                        IAS: ${s.marks.IAS}, MSE: ${s.marks.MSE}, ESE: ${s.marks.ESE}, Total: ${s.marks.total}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                chunksContainer.appendChild(chunkElement);
            });
        }
        
        socket.on('connect', () => {
            appendLog('Connected to server.', 'success');
            // Request initial data when connected
            fetch('/api/db_status').then(res => res.json()).then(data => {
                renderChunks(data.db_data);
                updateLockStatus(data.locks);
            });
        });

        socket.on('db_log', (data) => {
            appendLog(data.log);
        });

        socket.on('db_status_update', (data) => {
            renderChunks(data.db_data);
            updateLockStatus(data.locks);
            appendLog('Database status updated.', 'secondary');
        });

        function updateLockStatus(locks) {
            Object.entries(locks).forEach(([chunkId, lock]) => {
                const statusSpan = document.getElementById(`lock-status-${chunkId}`);
                if (statusSpan) {
                    statusSpan.classList.remove('unlocked', 'read-locked', 'write-locked');
                    if (lock.writer) {
                        statusSpan.textContent = 'Write Locked';
                        statusSpan.classList.add('write-locked');
                    } else if (lock.readers > 0) {
                        statusSpan.textContent = 'Read Locked';
                        statusSpan.classList.add('read-locked');
                    } else {
                        statusSpan.textContent = 'Unlocked';
                        statusSpan.classList.add('unlocked');
                    }
                }
            });
        }

        // Handle forms and buttons
        document.getElementById('read-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const roll = document.getElementById('read-roll').value;
            fetch(`/read?roll=${roll}`).then(res => res.json()).then(data => {
                const outputDiv = document.getElementById('read-output');
                if (data.error) {
                    outputDiv.innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
                } else {
                    outputDiv.innerHTML = `<p class="text-success">
                        <strong>Roll ${data.roll}</strong>: ${data.name} <br>
                        IAS: ${data.marks.IAS}, MSE: ${data.marks.MSE}, ESE: ${data.marks.ESE}, Total: ${data.marks.total}
                    </p>`;
                }
            });
        });

        document.getElementById('lock-btn').addEventListener('click', () => {
            const roll = document.getElementById('read-roll').value;
            fetch('/lock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({roll: roll})
            }).then(res => res.json()).then(data => {
                appendLog(`Lock request for Roll ${roll}: ${data.msg || data.error}`, data.success ? 'success' : 'danger');
            });
        });

        document.getElementById('unlock-btn').addEventListener('click', () => {
            const roll = document.getElementById('read-roll').value;
            fetch('/unlock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({roll: roll})
            }).then(res => res.json()).then(data => {
                appendLog(`Unlock request for Roll ${roll}: ${data.msg || data.error}`, data.success ? 'success' : 'danger');
            });
        });

        document.getElementById('write-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const roll = document.getElementById('write-roll').value;
            const ias = document.getElementById('write-ias').value;
            const mse = document.getElementById('write-mse').value;
            const ese = document.getElementById('write-ese').value;
            const marks = {};
            if(ias) marks.IAS = parseInt(ias);
            if(mse) marks.MSE = parseInt(mse);
            if(ese) marks.ESE = parseInt(ese);

            fetch('/write', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({roll: roll, marks: marks})
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    appendLog(`Write successful for Roll ${roll}.`, 'success');
                } else {
                    appendLog(`Write failed for Roll ${roll}: ${data.error}`, 'danger');
                }
            });
        });
    </script>
</body>
</html>
